# TODO: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆé–‹ç™ºãŒé€²ã‚“ã ã‚‰æœ‰åŠ¹åŒ–ï¼‰
# name: Production Deployment

# ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆå¿…è¦ãªSecretsè¨­å®šãŒæœªå®Œäº†ã®ãŸã‚ï¼‰
on:
  # push:
  #   branches: [ main ]
  #   tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (ç¾åœ¨ç„¡åŠ¹åŒ–ä¸­)'
        required: true
        default: 'disabled'
        type: choice
        options:
          - disabled

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  ZONE: asia-northeast1-a
  SERVICE_NAME: m4a-transcribe
  REGISTRY: gcr.io

jobs:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Semgrep security scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  build-and-push:
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker to use gcloud
        run: gcloud auth configure-docker

      - name: Generate image tag
        id: image-tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            TAG=${GITHUB_SHA::8}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Run container security scan
        run: |
          gcloud container images scan \
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.image-tag.outputs.tag }} \
            --location=${{ env.REGION }}

  # æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    environment: 
      name: production
      url: https://m4a-transcribe.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to Google Cloud Build
        run: |
          gcloud builds submit --config=deploy/gcp/cloudbuild.yaml \
            --substitutions=COMMIT_SHA=${{ needs.build-and-push.outputs.image-tag }},_ENVIRONMENT=production

      - name: Wait for deployment completion
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 120

      - name: Run health check
        run: |
          LOAD_BALANCER_IP=$(gcloud compute addresses describe m4a-transcribe-global-ip --global --format="value(address)")
          for i in {1..10}; do
            if curl -f -s http://$LOAD_BALANCER_IP/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 30
          done
          echo "Health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          LOAD_BALANCER_IP=$(gcloud compute addresses describe m4a-transcribe-global-ip --global --format="value(address)")
          
          # APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          curl -f http://$LOAD_BALANCER_IP/api/v1/status
          
          # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
          curl -f -s http://$LOAD_BALANCER_IP/static/dashboard.html > /dev/null

  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.m4a-transcribe.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY_STAGING }}
          project_id: ${{ secrets.GCP_PROJECT_ID_STAGING }}

      - name: Deploy to staging
        run: |
          gcloud builds submit --config=deploy/gcp/cloudbuild.yaml \
            --substitutions=COMMIT_SHA=${{ needs.build-and-push.outputs.image-tag }},_ENVIRONMENT=staging

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance-test:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run performance tests
        run: |
          LOAD_BALANCER_IP=$(gcloud compute addresses describe m4a-transcribe-global-ip --global --format="value(address)")
          export TARGET_URL="http://$LOAD_BALANCER_IP"
          
          k6 run tests/performance/basic-load-test.js
          k6 run tests/performance/stress-test.js

  # é€šçŸ¥
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-production, performance-test]
    if: always()
    steps:
      - name: Notify Slack on success
        if: ${{ success() }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ğŸš€ M4Aè»¢å†™ã‚·ã‚¹ãƒ†ãƒ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
            â€¢ ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: ${{ github.event.head_commit.timestamp }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: ${{ failure() }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            âŒ M4Aè»¢å†™ã‚·ã‚¹ãƒ†ãƒ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—
            â€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
            â€¢ ã‚¨ãƒ©ãƒ¼ç¢ºèª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
  rollback:
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    needs: [deploy-production]
    environment: production
    steps:
      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Rollback deployment
        run: |
          # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          gcloud compute instance-groups managed rolling-action restart \
            m4a-transcribe-mig --zone=${{ env.ZONE }}

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          channel: '#deployments'
          text: |
            âš ï¸ M4Aè»¢å†™ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            â€¢ å¤±æ•—ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            â€¢ ç¢ºèªãŒå¿…è¦ã§ã™
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}